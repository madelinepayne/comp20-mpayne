<!DOCTYPE html>
<html>
<head>
    <title>Not Uber</title>
<!--     <script type="text/javascript" src=src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxhem2x2mWEHYY0qs_NOqjYotDFCX8Mvc&callback=init"
    async defer></script> -->
    <script src="http://maps.googleapis.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script> 
    <!-- <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script> -->
    <link rel="stylesheet" href="index.css" />
    

</head>
<body onload="init()">
    <div id="map_canvas"></div>
</body>
<script type="text/javascript">
        var mylat = 0;
        var mylng = 0;
        var me = new google.maps.LatLng(mylat, mylng);
        var myOptions = {
            zoom: 13,
            center: me,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;
        var marker;
        var infowindow = new google.maps.InfoWindow();
        var request = new XMLHttpRequest();
        var username = "ZoxN11Sa";
        var p_marker = {
            url: 'https://img.clipartfox.com/7151250dd1619b1d45a9f068d7cdae0f_illustrated-silhouette-of-a-person-clipart-silhouette-no-background_958-958.png',
            scaledSize: new google.maps.Size(40,40)
            // anchor: new google.maps.Point(mylat, mylng)
        }
        var v_marker = {
            url: 'http://www.newdesignfile.com/postpic/2013/01/car-icons-free-download_293908.png',
            scaledSize: new google.maps.Size(40,40)
        }
        
        function init()
        {
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            getMyLocation();
            run();
        }
        
        function getMyLocation()
        {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    mylat = position.coords.latitude;
                    mylng = position.coords.longitude;
                    renderMap();
                });
            }
            else {
                alert("Geolocation is not supported on your web browser.");
            }
        }
        
        function renderMap()
        {
            me = new google.maps.LatLng(mylat,mylng);
            
            map.panTo(me);
            
            marker = new google.maps.Marker({
                position: me,
                title: "ZoxN11Sa",
                icon: p_marker
            });
            marker.setMap(map);
            
            google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent(marker.title);
                // infowindow.setContent(marker.distance);
                infowindow.open(map, marker);
            });
        }
        function run() {
            request.open("POST", "https://defense-in-derpth.herokuapp.com/submit", true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            var data_to_send = "username=" + username + "&lat=" + mylat + "&lng=" + mylng;
            request.send(data_to_send);
            
            request.onreadystatechange = function addMarkers() {
                if (request.readyState == 4 && request.status == 200) {
                    var jsonObj = request.responseText;
                    var elements = JSON.parse(jsonObj);
                // console.log(jsonObj[2]);
                // console.log(elements);
                // console.log(Object.keys(elements.vehicles).length);
                for (var i = 0; i < Object.keys(elements).length; i++){
                    // console.log("in for loop");
                    if (jsonObj[2] == "p") {
                        var passenger = new google.maps.LatLng(elements.passengers[i].lat, elements.passengers[i].lng);
                        var distance = google.maps.geometry.spherical.computeDistanceBetween(vehicle, me);
                        marker = new google.maps.Marker({
                            position: passenger,
                            title: String(elements.passengers[i].username),
                            label: String(distance),
                            icon: p_marker
                        });
                        marker.setMap(map);
                    }
                    if (jsonObj[2] == "v") {
                        var vehicle = new google.maps.LatLng(elements.vehicles[i].lat, elements.vehicles[i].lng);
                        var distance = google.maps.geometry.spherical.computeDistanceBetween(vehicle, me);
                        console.log(vehicle);
                        console.log(String(elements.vehicles[i].username));
                        marker = new google.maps.Marker({
                            position: vehicle,
                            title: String(elements.vehicles[i].username),
                            label: String(distance),
                            icon: v_marker,
                            map: map
                        });
                        
                        marker.setMap(map);
                    }
                    console.log(i);
                }
                    // console.log(jsonObj);
                    // console.log(elements);

                    
                }
            }
            // google.maps.event.addDomListener(window, 'load', initialize);
        }

    </script>
</html>